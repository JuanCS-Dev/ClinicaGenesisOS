rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS
    // ========================================

    /**
     * Check if the request is from an authenticated user.
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Check if the authenticated user owns the document.
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    /**
     * Get the user profile document for the authenticated user.
     */
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /**
     * Check if the authenticated user belongs to the specified clinic.
     * Reads the user's profile to get their clinicId.
     */
    function belongsToClinic(clinicId) {
      return isAuthenticated() && getUserProfile().clinicId == clinicId;
    }

    /**
     * Check if the authenticated user is the owner of the specified clinic.
     */
    function isClinicOwner(clinicId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/clinics/$(clinicId)).data.ownerId == request.auth.uid;
    }

    // ========================================
    // USER PROFILES
    // ========================================

    /**
     * User profiles are stored in /users/{userId}
     * Each user can only read/write their own profile.
     * Other authenticated users can read profiles (for clinic collaboration).
     */
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // ========================================
    // PATIENT PORTAL USERS
    // ========================================

    /**
     * Patient portal profiles are stored in /patientPortalUsers/{userId}
     * Each patient can only read/write their own profile.
     * Used for magic link (passwordless) authentication.
     */
    match /patientPortalUsers/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ========================================
    // CLINICS
    // ========================================

    /**
     * Clinics are stored in /clinics/{clinicId}
     * - Any authenticated user can create a clinic (becomes owner)
     * - Only clinic members can read clinic data
     * - Only clinic owner can update/delete
     */
    match /clinics/{clinicId} {
      allow read: if belongsToClinic(clinicId);
      allow create: if isAuthenticated();
      allow update: if isClinicOwner(clinicId);
      allow delete: if isClinicOwner(clinicId);

      // ========================================
      // PATIENTS (Clinic Subcollection)
      // ========================================

      /**
       * Patients are stored in /clinics/{clinicId}/patients/{patientId}
       * Only clinic members can access patient data.
       */
      match /patients/{patientId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // APPOINTMENTS (Clinic Subcollection)
      // ========================================

      /**
       * Appointments are stored in /clinics/{clinicId}/appointments/{appointmentId}
       * Only clinic members can access appointment data.
       */
      match /appointments/{appointmentId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // MEDICAL RECORDS (Clinic Subcollection)
      // ========================================

      /**
       * Medical records are stored in /clinics/{clinicId}/records/{recordId}
       * Only clinic members can access medical records.
       * Note: Records are polymorphic (SOAP, Prescription, etc.)
       */
      match /records/{recordId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // AI SCRIBE SESSIONS (Clinic Subcollection)
      // ========================================

      /**
       * AI Scribe sessions track audio processing status.
       * Created by frontend, updated by Cloud Function.
       */
      match /aiScribeSessions/{sessionId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // LAB ANALYSIS SESSIONS (Clinic Subcollection)
      // ========================================

      /**
       * Lab analysis sessions for Clinical Reasoning Engine.
       * Created by frontend, processed by Cloud Function.
       */
      match /labAnalysisSessions/{sessionId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // AI ANALYSIS LOGS (Clinic Subcollection)
      // ========================================

      /**
       * Audit logs for AI analysis operations.
       * Read-only for clinic members, write by Cloud Functions.
       */
      match /aiAnalysisLogs/{logId} {
        allow read: if belongsToClinic(clinicId);
        allow write: if false; // Only Cloud Functions can write
      }

      // ========================================
      // SETTINGS (Clinic Subcollection)
      // ========================================

      /**
       * Clinic settings and integrations configuration.
       */
      match /settings/{settingId} {
        allow read: if belongsToClinic(clinicId);
        allow write: if isClinicOwner(clinicId);
      }

      // ========================================
      // TRANSACTIONS (Clinic Subcollection)
      // ========================================

      /**
       * Financial transactions for the clinic.
       */
      match /transactions/{transactionId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // CONSENTS (Clinic Subcollection)
      // ========================================

      /**
       * Patient consent records.
       */
      match /consents/{consentId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // OPERADORAS (Clinic Subcollection)
      // ========================================

      /**
       * Health insurance operators.
       */
      match /operadoras/{operadoraId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // GUIAS (Clinic Subcollection)
      // ========================================

      /**
       * TISS authorization guides.
       */
      match /guias/{guiaId} {
        allow read, write: if belongsToClinic(clinicId);
      }

      // ========================================
      // GLOSAS (Clinic Subcollection)
      // ========================================

      /**
       * Insurance claim denials/disputes.
       */
      match /glosas/{glosaId} {
        allow read, write: if belongsToClinic(clinicId);
      }
    }
  }
}
