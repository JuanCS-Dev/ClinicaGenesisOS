rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // HELPER FUNCTIONS - SECURE RBAC
    // ========================================

    /**
     * Check if request is from authenticated user.
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Get clinic ID from custom claims.
     * More secure than reading user document (can't be spoofed).
     */
    function getClinicId() {
      return request.auth.token.clinicId;
    }

    /**
     * Get user role from custom claims.
     */
    function getUserRole() {
      return request.auth.token.role;
    }

    /**
     * Check if user belongs to the specified clinic.
     * Uses custom claims for security.
     */
    function belongsToClinic(clinicId) {
      return isAuthenticated() && getClinicId() == clinicId;
    }

    /**
     * Check if user is clinic owner.
     */
    function isClinicOwner(clinicId) {
      return belongsToClinic(clinicId) && getUserRole() == 'owner';
    }

    /**
     * Check if user is clinic admin (owner or admin).
     */
    function isClinicAdmin(clinicId) {
      return belongsToClinic(clinicId) && getUserRole() in ['owner', 'admin'];
    }

    /**
     * Check if user has one of the specified roles.
     * @param clinicId - Clinic to check membership
     * @param roles - List of allowed roles
     */
    function hasRole(clinicId, roles) {
      return belongsToClinic(clinicId) && getUserRole() in roles;
    }

    /**
     * Check if user can access clinical data (medical records).
     * Restricted to clinical staff only.
     */
    function isClinicalStaff(clinicId) {
      return hasRole(clinicId, ['owner', 'admin', 'professional']);
    }

    // ========================================
    // USER PROFILES
    // ========================================

    /**
     * User profiles: /users/{userId}
     * - User can read own profile
     * - Users can read profiles from same clinic (for collaboration)
     * - Only own user can write their profile
     */
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        (getClinicId() != null && getClinicId() == resource.data.clinicId)
      );
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // ========================================
    // PATIENT PORTAL USERS
    // ========================================

    /**
     * Patient portal profiles: /patientPortalUsers/{userId}
     * Separate from staff users, used for patient self-service.
     */
    match /patientPortalUsers/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ========================================
    // PHONE INDEX (for WhatsApp lookups)
    // ========================================

    /**
     * Phone index: /phoneIndex/{phone}
     * Read-only for authenticated users, write by Cloud Functions.
     */
    match /phoneIndex/{phone} {
      allow read: if isAuthenticated();
      allow write: if false; // Cloud Functions only
    }

    // ========================================
    // CLINICS
    // ========================================

    /**
     * Clinics: /clinics/{clinicId}
     * - Any authenticated user can create (becomes owner via trigger)
     * - Only members can read
     * - Only owner can update/delete
     */
    match /clinics/{clinicId} {
      allow read: if belongsToClinic(clinicId);
      allow create: if isAuthenticated();
      allow update: if isClinicOwner(clinicId);
      allow delete: if isClinicOwner(clinicId);

      // ========================================
      // PATIENTS
      // ========================================

      /**
       * Patients: /clinics/{clinicId}/patients/{patientId}
       * - All staff can read
       * - All staff can create/update (receptionists need to register)
       * - Only owner can delete (prefer soft delete)
       */
      match /patients/{patientId} {
        allow read: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow create: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow update: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow delete: if isClinicOwner(clinicId);
      }

      // ========================================
      // MEDICAL RECORDS - RESTRICTED
      // ========================================

      /**
       * Medical records: /clinics/{clinicId}/records/{recordId}
       * HIPAA/LGPD compliant:
       * - Only clinical staff can read (no receptionists)
       * - Only professionals can create/update
       * - NEVER delete (compliance requirement)
       */
      match /records/{recordId} {
        allow read: if isClinicalStaff(clinicId);
        allow create: if hasRole(clinicId, ['owner', 'professional']);
        allow update: if hasRole(clinicId, ['owner', 'professional']);
        allow delete: if false; // Never delete medical records
      }

      // ========================================
      // APPOINTMENTS
      // ========================================

      /**
       * Appointments: /clinics/{clinicId}/appointments/{appointmentId}
       * - All staff can read and manage
       * - Only admins can delete
       */
      match /appointments/{appointmentId} {
        allow read: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow create: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow update: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow delete: if isClinicAdmin(clinicId);
      }

      // ========================================
      // AI SCRIBE SESSIONS - IMMUTABLE
      // ========================================

      /**
       * AI Scribe sessions: /clinics/{clinicId}/aiScribeSessions/{sessionId}
       * Audit trail - immutable after creation.
       */
      match /aiScribeSessions/{sessionId} {
        allow read: if isClinicalStaff(clinicId);
        allow create: if hasRole(clinicId, ['owner', 'professional']);
        allow update, delete: if false; // Immutable for audit
      }

      // ========================================
      // LAB ANALYSIS SESSIONS - IMMUTABLE
      // ========================================

      /**
       * Lab analysis: /clinics/{clinicId}/labAnalysisSessions/{sessionId}
       * Clinical Reasoning Engine results - immutable.
       */
      match /labAnalysisSessions/{sessionId} {
        allow read: if isClinicalStaff(clinicId);
        allow create: if hasRole(clinicId, ['owner', 'professional']);
        allow update, delete: if false; // Immutable for audit
      }

      // ========================================
      // AI ANALYSIS LOGS - APPEND ONLY
      // ========================================

      /**
       * AI audit logs: /clinics/{clinicId}/aiAnalysisLogs/{logId}
       * Read-only for clinic, write by Cloud Functions only.
       */
      match /aiAnalysisLogs/{logId} {
        allow read: if belongsToClinic(clinicId);
        allow write: if false; // Cloud Functions only
      }

      // ========================================
      // SETTINGS
      // ========================================

      /**
       * Clinic settings: /clinics/{clinicId}/settings/{settingId}
       * - All members can read
       * - Only owner can write
       */
      match /settings/{settingId} {
        allow read: if belongsToClinic(clinicId);
        allow write: if isClinicOwner(clinicId);
      }

      // ========================================
      // TRANSACTIONS - FINANCIAL
      // ========================================

      /**
       * Financial transactions: /clinics/{clinicId}/transactions/{transactionId}
       * Restricted to admin+ for privacy.
       */
      match /transactions/{transactionId} {
        allow read: if isClinicAdmin(clinicId);
        allow create: if isClinicAdmin(clinicId);
        allow update: if isClinicAdmin(clinicId);
        allow delete: if isClinicOwner(clinicId);
      }

      // ========================================
      // PAYMENTS - PIX/BOLETO
      // ========================================

      /**
       * Payments: /clinics/{clinicId}/payments/{paymentId}
       * Created by Cloud Functions, read by admin+.
       */
      match /payments/{paymentId} {
        allow read: if isClinicAdmin(clinicId);
        allow create: if false; // Cloud Functions only
        allow update: if false; // Cloud Functions only
        allow delete: if false; // Never delete payment records
      }

      // ========================================
      // CONSENTS - LGPD
      // ========================================

      /**
       * Patient consents: /clinics/{clinicId}/consents/{consentId}
       * LGPD compliant - immutable after creation.
       */
      match /consents/{consentId} {
        allow read: if belongsToClinic(clinicId);
        allow create: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow update, delete: if false; // Consents are immutable
      }

      // ========================================
      // TISS - OPERADORAS
      // ========================================

      /**
       * Health insurance operators: /clinics/{clinicId}/operadoras/{operadoraId}
       */
      match /operadoras/{operadoraId} {
        allow read: if belongsToClinic(clinicId);
        allow write: if isClinicAdmin(clinicId);
      }

      // ========================================
      // TISS - GUIAS
      // ========================================

      /**
       * Authorization guides: /clinics/{clinicId}/guias/{guiaId}
       */
      match /guias/{guiaId} {
        allow read: if belongsToClinic(clinicId);
        allow create: if hasRole(clinicId, ['owner', 'admin', 'professional']);
        allow update: if hasRole(clinicId, ['owner', 'admin', 'professional']);
        allow delete: if isClinicOwner(clinicId);
      }

      // ========================================
      // TISS - GLOSAS
      // ========================================

      /**
       * Insurance claim denials: /clinics/{clinicId}/glosas/{glosaId}
       */
      match /glosas/{glosaId} {
        allow read: if belongsToClinic(clinicId);
        allow write: if isClinicAdmin(clinicId);
      }

      // ========================================
      // TISS - LOTES
      // ========================================

      /**
       * TISS batches: /clinics/{clinicId}/lotes/{loteId}
       */
      match /lotes/{loteId} {
        allow read: if belongsToClinic(clinicId);
        allow write: if isClinicAdmin(clinicId);
      }

      // ========================================
      // TISS - CERTIFICATES
      // ========================================

      /**
       * Digital certificates: /clinics/{clinicId}/certificates/{certId}
       * Owner only - sensitive encryption data.
       */
      match /certificates/{certId} {
        allow read: if isClinicOwner(clinicId);
        allow write: if isClinicOwner(clinicId);
      }

      // ========================================
      // COMPANION SESSIONS
      // ========================================

      /**
       * AI Companion chat sessions: /clinics/{clinicId}/companionSessions/{sessionId}
       * Write by Cloud Functions, read by clinical staff.
       */
      match /companionSessions/{sessionId} {
        allow read: if isClinicalStaff(clinicId);
        allow write: if false; // Cloud Functions only
      }

      // ========================================
      // COMPANION HANDOFFS
      // ========================================

      /**
       * Companion to human handoffs: /clinics/{clinicId}/companionHandoffs/{handoffId}
       */
      match /companionHandoffs/{handoffId} {
        allow read: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow write: if false; // Cloud Functions only
      }

      // ========================================
      // TELEMEDICINE SESSIONS
      // ========================================

      /**
       * Telemedicine/teleconsultation sessions.
       */
      match /telemedicineSessions/{sessionId} {
        allow read: if belongsToClinic(clinicId);
        allow create: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow update: if hasRole(clinicId, ['owner', 'admin', 'professional', 'receptionist']);
        allow delete: if isClinicAdmin(clinicId);
      }

      // ========================================
      // AUDIT LOGS - READ ONLY
      // ========================================

      /**
       * Audit logs: /clinics/{clinicId}/auditLogs/{logId}
       * Append-only by Cloud Functions.
       */
      match /auditLogs/{logId} {
        allow read: if belongsToClinic(clinicId);
        allow write: if false; // Cloud Functions only
      }
    }
  }
}
