#!/bin/bash
# CODE_CONSTITUTION Pre-commit Guardrails

# Exit on error
set -e

echo "ğŸ” Running pre-commit checks..."

# 1. File size check (max 500 lines per CODE_CONSTITUTION)
# Only check STAGED files, not all files
echo "ğŸ“ Checking file sizes..."
git diff --cached --name-only --diff-filter=ACM | grep -E "\.tsx?$" | while read file; do
  if [ -f "$file" ]; then
    lines=$(wc -l < "$file")
    if [ "$lines" -gt 500 ]; then
      echo "âŒ BLOCKED: $file has $lines lines (max 500)"
      exit 1
    fi
  fi
done

# 2. Design tokens check (no hardcoded bg-white without dark: variant)
echo "ğŸ¨ Checking design tokens..."
if git diff --cached --name-only | grep -E "\.tsx$" | xargs grep -l "bg-white" 2>/dev/null | xargs grep "bg-white" 2>/dev/null | grep -v "dark:"; then
  echo "âš ï¸  WARNING: Found bg-white without dark: variant. Use bg-genesis-surface instead."
fi

# 3. Run lint-staged (ESLint + Prettier on staged files)
echo "âœ¨ Running lint-staged..."
npx lint-staged

# 4. TypeScript check
echo "ğŸ“¦ Running TypeScript check..."
npm run typecheck

echo "âœ… All pre-commit checks passed!"
