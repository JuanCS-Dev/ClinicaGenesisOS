rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ========================================
    // HELPER FUNCTIONS - SECURE RBAC
    // ========================================

    /**
     * Check if request is from authenticated user.
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Get clinic ID from custom claims.
     */
    function getClinicId() {
      return request.auth.token.clinicId;
    }

    /**
     * Get user role from custom claims.
     */
    function getUserRole() {
      return request.auth.token.role;
    }

    /**
     * Check if user belongs to the specified clinic.
     */
    function belongsToClinic(clinicId) {
      return isAuthenticated() && getClinicId() == clinicId;
    }

    /**
     * Check if user has one of the specified roles.
     */
    function hasRole(clinicId, roles) {
      return belongsToClinic(clinicId) && getUserRole() in roles;
    }

    /**
     * Check if user is clinical staff (can access medical files).
     */
    function isClinicalStaff(clinicId) {
      return hasRole(clinicId, ['owner', 'admin', 'professional']);
    }

    // ========================================
    // PATIENT AVATARS
    // ========================================

    /**
     * Patient avatars: /clinics/{clinicId}/avatars/{fileName}
     * All clinic staff can read/write.
     */
    match /clinics/{clinicId}/avatars/{fileName} {
      allow read: if belongsToClinic(clinicId);
      allow write: if belongsToClinic(clinicId)
        && request.resource.size < 5 * 1024 * 1024  // Max 5MB
        && request.resource.contentType.matches('image/.*');
    }

    // ========================================
    // MEDICAL ATTACHMENTS - RESTRICTED
    // ========================================

    /**
     * Record attachments: /clinics/{clinicId}/attachments/{fileName}
     * Only clinical staff can access medical attachments.
     */
    match /clinics/{clinicId}/attachments/{fileName} {
      allow read: if isClinicalStaff(clinicId);
      allow write: if isClinicalStaff(clinicId)
        && request.resource.size < 20 * 1024 * 1024;  // Max 20MB
    }

    // ========================================
    // AI SCRIBE RECORDINGS - RESTRICTED
    // ========================================

    /**
     * Audio recordings: /recordings/{clinicId}/{date}/{patientId}/{fileName}
     * Only clinical staff can access audio recordings (PHI).
     */
    match /recordings/{clinicId}/{date}/{patientId}/{fileName} {
      allow read: if isClinicalStaff(clinicId);
      allow write: if hasRole(clinicId, ['owner', 'professional'])
        && request.resource.size < 100 * 1024 * 1024;  // Max 100MB (~30min audio)
    }

    // ========================================
    // LAB DOCUMENTS - RESTRICTED
    // ========================================

    /**
     * Lab documents: /clinics/{clinicId}/labDocuments/{patientId}/{fileName}
     * Clinical Reasoning Engine - only clinical staff.
     */
    match /clinics/{clinicId}/labDocuments/{patientId}/{fileName} {
      allow read: if isClinicalStaff(clinicId);
      allow write: if hasRole(clinicId, ['owner', 'professional'])
        && request.resource.size < 15 * 1024 * 1024  // Max 15MB
        && (request.resource.contentType.matches('image/.*')
            || request.resource.contentType == 'application/pdf');
    }

    // ========================================
    // RECORD ATTACHMENTS - RESTRICTED
    // ========================================

    /**
     * Record-specific attachments: /clinics/{clinicId}/records/{recordId}/attachments/{fileName}
     * Only clinical staff can access medical record attachments.
     */
    match /clinics/{clinicId}/records/{recordId}/attachments/{fileName} {
      allow read: if isClinicalStaff(clinicId);
      allow write: if hasRole(clinicId, ['owner', 'professional'])
        && request.resource.size < 10 * 1024 * 1024;  // Max 10MB
    }

    // ========================================
    // PATIENT IMAGES (Alternative path)
    // ========================================

    /**
     * Patient images: /clinics/{clinicId}/patients/{patientId}/{fileName}
     * All staff can manage patient photos.
     */
    match /clinics/{clinicId}/patients/{patientId}/{fileName} {
      allow read: if belongsToClinic(clinicId);
      allow write: if belongsToClinic(clinicId)
        && request.resource.size < 5 * 1024 * 1024  // Max 5MB
        && request.resource.contentType.matches('image/.*');
    }

    // ========================================
    // TISS CERTIFICATES - OWNER ONLY
    // ========================================

    /**
     * Digital certificates: /clinics/{clinicId}/certificates/{fileName}
     * Only clinic owner can access certificates.
     */
    match /clinics/{clinicId}/certificates/{fileName} {
      allow read: if hasRole(clinicId, ['owner']);
      allow write: if hasRole(clinicId, ['owner'])
        && request.resource.size < 10 * 1024 * 1024;  // Max 10MB
    }

    // ========================================
    // CLINIC LOGOS AND BRANDING
    // ========================================

    /**
     * Clinic branding: /clinics/{clinicId}/branding/{fileName}
     * All staff can read, admin+ can write.
     */
    match /clinics/{clinicId}/branding/{fileName} {
      allow read: if belongsToClinic(clinicId);
      allow write: if hasRole(clinicId, ['owner', 'admin'])
        && request.resource.size < 5 * 1024 * 1024  // Max 5MB
        && request.resource.contentType.matches('image/.*');
    }

    // ========================================
    // BLOCK ALL OTHER PATHS
    // ========================================

    /**
     * Deny all other access by default.
     * Security best practice: explicit allow, implicit deny.
     */
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
